{
  "feature": "Implement 24F-2NT Parser",
  "slug": "implement-24f-2nt-parser",
  "created": "2026-02-13",
  "status": "approved",
  "phases": [
    {
      "id": "phase-1",
      "name": "Schema Change",
      "stories": ["US-1"],
      "description": "Modify FlowData model from per-ETF to per-CIK. Update SCHEMA.md. Fix existing tests."
    },
    {
      "id": "phase-2",
      "name": "Parser + CLI",
      "stories": ["US-2", "US-3"],
      "description": "Implement flows.py parser and wire up CLI command with --cik, --limit, --keep-cache flags."
    },
    {
      "id": "phase-3",
      "name": "Tests",
      "stories": ["US-4"],
      "description": "Write comprehensive test suite for the parser."
    },
    {
      "id": "phase-4",
      "name": "Integration Verification",
      "stories": [],
      "description": "Run full test suite, verify no regressions from schema change."
    }
  ],
  "stories": [
    {
      "id": "US-1",
      "title": "Modify FlowData Model",
      "acceptance_criteria": [
        "FlowData model has cik string column, no etf_id",
        "UniqueConstraint on (cik, fiscal_year_end) enforced",
        "All existing tests pass",
        "SCHEMA.md updated"
      ]
    },
    {
      "id": "US-2",
      "title": "Implement XML Parser Core",
      "acceptance_criteria": [
        "Correctly extracts sales_value, redemptions_value, net_sales, fiscal_year_end from XML",
        "Handles accounting-notation negatives (X.XX)",
        "Handles missing fields gracefully",
        "Handles no XML content gracefully",
        "Upserts correctly on re-run",
        "Clears edgartools cache unless --keep-cache"
      ]
    },
    {
      "id": "US-3",
      "title": "Wire Up CLI Command",
      "acceptance_criteria": [
        "etf-pipeline flows runs the parser",
        "--cik, --limit, --keep-cache flags work correctly",
        "Logging configured at INFO level"
      ]
    },
    {
      "id": "US-4",
      "title": "Comprehensive Tests",
      "acceptance_criteria": [
        "Happy path test passes",
        "Money parsing edge cases covered",
        "Upsert behavior tested",
        "Error conditions tested (no filings, no XML, missing fields)",
        "CIK filtering and limit tested",
        "All tests pass with no network calls"
      ]
    }
  ],
  "decisions": {
    "data_granularity": "Trust-level (per-CIK), not per-ETF. Real filings confirmed aggregate-only.",
    "schema_change": "Replace FlowData.etf_id FK with FlowData.cik VARCHAR(10), no FK relationship",
    "fetch_strategy": "edgartools Company.get_filings(form='24F-2NT'), then filing.xml()",
    "history_depth": "Latest filing only per CIK",
    "dedup_strategy": "Upsert (update on conflict)",
    "aggregate_handling": "All real filings are aggregate; seriesOrClassId is never populated",
    "cik_discovery": "Accept ciks list param for pipeline use; fallback to DB query for standalone",
    "money_parsing": "Handle accounting-notation negatives, strip commas",
    "testing": "Mock filing.xml() with inline XML strings"
  }
}
